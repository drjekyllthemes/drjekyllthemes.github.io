<!-- Inverted Relation -->
<!-- ================= -->

{% assign __empty_array = '' | split: ',' %}
{% assign inverted_keys = __empty_array %}
{% assign inverted_values = __empty_array %}
{% assign __keys =  include.collection | map: include.field %}
{% assign __one_to_many = __keys.first.first %}

<!-- flatten -->
{% if __one_to_many %}
  {% assign __keys =  __keys | join: ',' | join: ',' | split: ',' %}
{% endif %}

<!-- uniq -->
{% assign __keys =  __keys | sort %}
{% for key in __keys | sort %}

  <!-- If not equal to previous then it must be unique as sorted -->
  {% unless key == previous %}

    <!-- Push to inverted_keys -->
    {% assign inverted_keys = inverted_keys | push: key %}
  {% endunless %}

  {% assign previous = key %}
{% endfor %}


<!-- inverted_values -->
{% for key in inverted_keys %}

  {% if __one_to_many %}

    <!-- Collect if contains -->
    {% assign __value = __empty_array %}
    {% for __element in include.collection %}
      {% if __element[include.field] contains key %}
        {% assign __value = __value | push: __element %}
      {% endif %}
    {% endfor %}

  {% else %}

    <!-- Collect where -->
    {% assign __value = include.collection | where: include.field, key %}

  {% endif %}

  <!-- Push to inverted_values -->
  {% assign inverted_values = inverted_values | push: __value %}
{% endfor %}

